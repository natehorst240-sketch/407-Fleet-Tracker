<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IHC Health Services — Bell 407 Due Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

  <style>
    :root{
      --bg:#0a0c0f;
      --surface:#111418;
      --surface2:#181c22;
      --border:#1e2530;
      --green:#00e676;
      --amber:#ffab00;
      --red:#ff1744;
      --overdue:#ff6d00;
      --blue:#29b6f6;
      --text:#cdd6e0;
      --muted:#4a5568;
      --heading:#e8edf2;
      --mono:'Share Tech Mono', monospace;
      --sans:'Barlow Condensed', sans-serif;
      --body:'Barlow', sans-serif;
      --radius:6px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--body);min-height:100vh;overflow-x:hidden;}
    body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);pointer-events:none;z-index:1000;}

    header{background:var(--surface);border-bottom:1px solid var(--border);padding:18px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:16px;}
    .logo{font-family:var(--sans);font-weight:900;font-size:20px;letter-spacing:3px;color:var(--heading);text-transform:uppercase;line-height:1;}
    .logo span{color:var(--blue);}
    .subtitle{margin-top:6px;font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;line-height:1.2;}
    .header-meta{font-family:var(--mono);font-size:11px;color:var(--muted);text-align:right;line-height:1.7;white-space:nowrap;}
    .header-meta .date{color:var(--blue);}

    main{max-width:1600px;margin:0 auto;padding:22px 28px 40px;}

    .legend{display:flex;flex-wrap:wrap;gap:16px;align-items:center;padding:10px 28px;background:var(--surface2);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:11px;color:var(--muted);}
    .legend-item{display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:1px;}
    .dot{width:8px;height:8px;border-radius:999px;}
    .dot-green{background:var(--green);box-shadow:0 0 6px var(--green);}
    .dot-amber{background:var(--amber);box-shadow:0 0 6px var(--amber);}
    .dot-red{background:var(--red);box-shadow:0 0 6px var(--red);}
    .dot-overdue{background:var(--overdue);box-shadow:0 0 6px var(--overdue);}

    .tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:18px;flex-wrap:wrap;}
    .tab-btn{font-family:var(--sans);font-size:13px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:12px 18px;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;border-bottom:3px solid transparent;}
    .tab-btn:hover{color:var(--text);background:rgba(255,255,255,0.02);}
    .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);}

    .tab-content{display:none;}
    .tab-content.active{display:block;}

    .summary-bar{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;}
    .summary-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;min-width:160px;flex:0 0 auto;}
    .stat-value{font-family:var(--sans);font-size:30px;font-weight:900;line-height:1;margin-bottom:6px;color:var(--heading);}
    .stat-label{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
    .divider-line{width:42px;height:2px;border-radius:1px;margin:6px 0 8px;background:var(--border);}

    .section-label{font-family:var(--sans);font-size:11px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin:22px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border);}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 14px;}
    .search{flex:1 1 280px;min-width:240px;display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;}
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:12px;}
    .chip-row{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:6px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:999px;cursor:pointer;transition:.12s;}
    .chip:hover{color:var(--text);border-color:rgba(41,182,246,0.35);}
    .chip.active{background:var(--blue);border-color:var(--blue);color:#000;}

    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .card-tail{font-family:var(--sans);font-weight:900;font-size:18px;letter-spacing:1px;color:var(--heading);display:flex;align-items:baseline;gap:10px;min-width:0;}
    .subline{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;white-space:nowrap;}

    .badge{display:inline-flex;align-items:center;gap:6px;font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);white-space:nowrap;flex:0 0 auto;}
    .b-overdue{color:var(--overdue);border-color:rgba(255,109,0,0.35);background:rgba(255,109,0,0.08);}
    .b-red{color:var(--red);border-color:rgba(255,23,68,0.35);background:rgba(255,23,68,0.08);}
    .b-amber{color:var(--amber);border-color:rgba(255,171,0,0.35);background:rgba(255,171,0,0.08);}
    .b-green{color:var(--green);border-color:rgba(0,230,118,0.35);background:rgba(0,230,118,0.06);}
    .b-na{color:var(--muted);}

    .card-body{padding:12px 14px;}
    .item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid rgba(30,37,48,0.7);}
    .item:last-child{border-bottom:none;}
    .bar{width:3px;height:34px;border-radius:2px;flex:0 0 auto;background:var(--border);margin-top:2px;}
    .bar.overdue{background:var(--overdue);box-shadow:0 0 10px rgba(255,109,0,0.25);}
    .bar.red{background:var(--red);box-shadow:0 0 10px rgba(255,23,68,0.18);}
    .bar.amber{background:var(--amber);box-shadow:0 0 10px rgba(255,171,0,0.14);}
    .bar.green{background:var(--green);box-shadow:0 0 10px rgba(0,230,118,0.14);}
    .item-main{min-width:0;flex:1 1 auto;}
    .item-title{font-family:var(--body);font-size:12px;font-weight:600;color:var(--text);line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-meta{margin-top:4px;font-family:var(--mono);font-size:10px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;}
    .mono-pill{border:1px solid rgba(74,85,104,0.35);padding:2px 6px;border-radius:4px;letter-spacing:.5px;text-transform:uppercase;}

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);}
    table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;min-width:920px;}
    thead th{background:var(--surface2);color:var(--muted);font-family:var(--sans);font-weight:800;letter-spacing:2px;text-transform:uppercase;font-size:11px;padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
    tbody td{padding:10px 12px;border-bottom:1px solid rgba(30,37,48,0.7);vertical-align:top;}
    tbody tr:hover{background:rgba(255,255,255,0.02);}
    .td-right{text-align:right;}
    .td-center{text-align:center;}
    .small{font-size:10px;color:var(--muted);}

    .empty{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-family:var(--mono);color:var(--muted);font-size:12px;}

    /* Utilization tab */
    .util-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:14px;}
    .util-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .util-card-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;}
    .util-tail{font-family:var(--sans);font-weight:900;font-size:16px;letter-spacing:1px;color:var(--heading);}
    .util-stats{display:flex;gap:18px;padding:10px 14px;border-bottom:1px solid var(--border);}
    .util-stat{text-align:center;}
    .util-stat-val{font-family:var(--sans);font-size:18px;font-weight:900;color:var(--blue);}
    .util-stat-lbl{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}
    .util-chart-wrap{padding:10px 14px;position:relative;height:140px;}
    .util-no-data{padding:20px 14px;font-family:var(--mono);font-size:11px;color:var(--muted);text-align:center;}

    footer{margin-top:38px;padding:16px 28px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--muted);display:flex;justify-content:space-between;letter-spacing:1px;flex-wrap:wrap;gap:10px;}
    .errbar{border:1px solid rgba(255,23,68,0.35);background:rgba(255,23,68,0.08);color:var(--red);padding:10px 12px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;margin:14px 0;}
    code{font-family:var(--mono);}

    @media(max-width:720px){
      header{padding:16px 18px;}
      .legend{padding:10px 18px;}
      main{padding:18px 18px 36px;}
    }
  </style>
</head>

<body>
<header>
  <div>
    <div class="logo">IHC <span>HEALTH</span> SERVICES</div>
    <div class="subtitle">Bell 407 Fleet — Inspections &amp; Due List</div>
  </div>
  <div class="header-meta">
    <div class="date" id="hdr-report-date">REPORT DATE: —</div>
    <div id="hdr-generated">GENERATED: —</div>
    <div id="hdr-source" class="small">SOURCE: data/dashboard.json</div>
  </div>
</header>

<div class="legend">
  <div class="legend-item"><div class="dot dot-green"></div> OK</div>
  <div class="legend-item"><div class="dot dot-amber"></div> Coming Due</div>
  <div class="legend-item"><div class="dot dot-red"></div> Critical</div>
  <div class="legend-item"><div class="dot dot-overdue"></div> Overdue</div>
  <div style="margin-left:auto">Date-driven items use <b>days remaining</b> first. Hour-driven items use <b>hours remaining</b>.</div>
</div>

<main>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('inspections',this)">Inspections</button>
    <button class="tab-btn" onclick="switchTab('ata',this)">ATA View</button>
    <button class="tab-btn" onclick="switchTab('utilization',this)">Utilization</button>
  </div>

  <div class="summary-bar">
    <div class="summary-stat">
      <div class="stat-value" id="sum-overdue" style="color:var(--overdue)">—</div>
      <div class="divider-line" style="background:var(--overdue)"></div>
      <div class="stat-label">Overdue</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-critical" style="color:var(--red)">—</div>
      <div class="divider-line" style="background:var(--red)"></div>
      <div class="stat-label">Critical</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-coming" style="color:var(--amber)">—</div>
      <div class="divider-line" style="background:var(--amber)"></div>
      <div class="stat-label">Coming Due</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-tracked" style="color:var(--blue)">—</div>
      <div class="divider-line" style="background:var(--blue)"></div>
      <div class="stat-label">Tracked Items</div>
    </div>
  </div>

  <div id="error-box" class="errbar" hidden></div>

  <!-- INSPECTIONS TAB -->
  <div id="tab-inspections" class="tab-content active">
    <div class="toolbar">
      <div class="search">
        <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">FILTER</span>
        <input id="q-aircraft" placeholder="Search tail, inspection name, or ATA…" autocomplete="off" />
      </div>
      <div class="chip-row" id="severity-chips">
        <button class="chip active" onclick="setSeverityFilter('all',this)">All</button>
        <button class="chip" onclick="setSeverityFilter('overdue',this)">Overdue</button>
        <button class="chip" onclick="setSeverityFilter('critical',this)">Critical</button>
        <button class="chip" onclick="setSeverityFilter('coming',this)">Coming</button>
        <button class="chip" onclick="setSeverityFilter('ok',this)">OK</button>
      </div>
    </div>
    <div class="section-label">Inspections by Aircraft</div>
    <div id="cards" class="cards"></div>
    <div id="empty-inspections" class="empty" hidden>No tracked inspection items found.</div>
  </div>

  <!-- ATA TAB -->
  <div id="tab-ata" class="tab-content">
    <div class="toolbar">
      <div class="search">
        <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">FILTER</span>
        <input id="q-ata" placeholder="Search ATA, inspection name, or tail…" autocomplete="off" />
      </div>
      <div class="chip-row">
        <button class="chip active" onclick="setAtaSort('severity',this)">Sort: Severity</button>
        <button class="chip" onclick="setAtaSort('ata',this)">Sort: ATA</button>
      </div>
    </div>
    <div class="section-label">Grouped by ATA Code</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ATA Code</th><th>Inspection</th><th>Aircraft</th>
            <th class="td-center">Status</th><th class="td-right">Days Rem</th>
            <th class="td-right">Hours Rem</th><th>Due Date</th>
          </tr>
        </thead>
        <tbody id="ata-tbody"></tbody>
      </table>
    </div>
    <div id="empty-ata" class="empty" hidden style="margin-top:12px;">No ATA-grouped items found.</div>
  </div>

  <!-- UTILIZATION TAB -->
  <div id="tab-utilization" class="tab-content">
    <div class="section-label">Fleet Utilization — Daily Flight Hours</div>
    <div id="util-grid" class="util-grid"></div>
    <div id="empty-util" class="empty" hidden>No utilization data available yet. History accumulates with each daily scraper run.</div>
  </div>
</main>

<footer>
  <span>IHC Health Services — Bell 407 Dashboard</span>
  <span id="ftr-right">—</span>
</footer>

<script>
Chart.register(ChartDataLabels);

const DASHBOARD_URL = "data/dashboard.json";
let DASH = null;
let severityFilter = "all";
let ataSortMode = "severity";
const utilCharts = {};

// ---- Tab switching --------------------------------------------------------
function switchTab(name, btn){
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + name).classList.add("active");
  if(name === "utilization") renderUtilization();
}

// ---- Severity filter ------------------------------------------------------
function setSeverityFilter(val, btn){
  severityFilter = val;
  document.querySelectorAll("#severity-chips .chip").forEach(c => c.classList.remove("active"));
  btn.classList.add("active");
  renderInspections();
}

function setAtaSort(mode, btn){
  ataSortMode = mode;
  btn.parentElement.querySelectorAll(".chip").forEach(c => c.classList.remove("active"));
  btn.classList.add("active");
  renderAta();
}

// ---- Utility functions ----------------------------------------------------
function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }

function fmtDate(d){
  if(!d) return "—";
  const dt = new Date(d + "T00:00:00");
  if(isNaN(dt)) return "—";
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
}

// ---- Data normalization ---------------------------------------------------
// aircraft[] is an array with {tail, airframe_hours, avg_daily, daily_data, items[]}
function normalizeItems(dash){
  const out = [];
  if(!Array.isArray(dash.aircraft)) return out;
  dash.aircraft.forEach(a => {
    const tail = a.tail || a.registration || "";
    const tt   = a.airframe_hours;
    (a.items || []).forEach(it => out.push({ tail, total_time: tt, ...it }));
  });
  return out;
}

// ---- Classification -------------------------------------------------------
function classifyItem(item){
  const days = item.remaining_days;
  if(days !== null && days !== undefined && days !== "" && !isNaN(Number(days))){
    const d = Number(days);
    if(d < 0)   return "overdue";
    if(d <= 7)  return "critical";
    if(d <= 30) return "coming";
    return "ok";
  }
  const hrs = item.remaining_hours;
  if(hrs !== null && hrs !== undefined && hrs !== "" && !isNaN(Number(hrs))){
    const h = Number(hrs);
    if(h < 0)    return "overdue";
    if(h <= 25)  return "critical";
    if(h <= 100) return "coming";
    return "ok";
  }
  const s = safeStr(item.status || item.next_due_status).toUpperCase();
  if(s.includes("PAST DUE")||s.includes("OVERDUE")) return "overdue";
  if(s.includes("CRITICAL"))  return "critical";
  if(s.includes("COMING"))    return "coming";
  if(s.includes("OK")||s.includes("TOLERANCE")) return "ok";
  return "na";
}

function scoreItem(item){
  const sev = classifyItem(item);
  const d = Number(item.remaining_days);
  const h = Number(item.remaining_hours);
  if(sev==="overdue")  return !isNaN(d) ? -100000+d : !isNaN(h) ? -90000+h : -80000;
  if(sev==="critical") return !isNaN(d) ?        d  : !isNaN(h) ?  2000+h  :  5000;
  if(sev==="coming")   return !isNaN(d) ? 10000+d   : !isNaN(h) ? 14000+h  : 18000;
  if(sev==="ok")       return !isNaN(d) ? 20000+d   : !isNaN(h) ? 24000+h  : 28000;
  return 99999;
}

function badgeFor(sev){
  if(sev==="overdue")  return `<span class="badge b-overdue">OVERDUE</span>`;
  if(sev==="critical") return `<span class="badge b-red">CRITICAL</span>`;
  if(sev==="coming")   return `<span class="badge b-amber">COMING</span>`;
  if(sev==="ok")       return `<span class="badge b-green">OK</span>`;
  return `<span class="badge b-na">—</span>`;
}

function barClass(sev){
  return {overdue:"overdue",critical:"red",coming:"amber",ok:"green"}[sev] || "";
}

// ---- Summary counts -------------------------------------------------------
function renderSummary(items){
  let overdue=0,critical=0,coming=0,tracked=0;
  items.forEach(it => {
    const sev = classifyItem(it);
    if(sev==="na") return;
    tracked++;
    if(sev==="overdue")  overdue++;
    else if(sev==="critical") critical++;
    else if(sev==="coming")   coming++;
  });
  document.getElementById("sum-overdue").textContent  = overdue;
  document.getElementById("sum-critical").textContent = critical;
  document.getElementById("sum-coming").textContent   = coming;
  document.getElementById("sum-tracked").textContent  = tracked;
}

// ---- Header ---------------------------------------------------------------
function updateHeader(meta){
  document.getElementById("hdr-report-date").textContent = `REPORT DATE: ${meta?.report_date || "—"}`;
  document.getElementById("hdr-generated").textContent   = `GENERATED: ${meta?.generated_utc || "—"}`;
  document.getElementById("hdr-source").textContent      = `SOURCE: ${meta?.source || "data/dashboard.json"}`;
  document.getElementById("ftr-right").textContent       = `Last update: ${meta?.generated_utc || "—"}`;
}

// ---- Inspections tab ------------------------------------------------------
function applyFilters(items, query){
  const q = query.trim().toLowerCase();
  return items.filter(it => {
    const sev = classifyItem(it);
    if(severityFilter !== "all"){
      if(severityFilter !== sev) return false;
    }
    if(!q) return true;
    const hay = [it.tail,it.inspection,it.ata,it.status,it.due_date].map(safeStr).join(" ").toLowerCase();
    return hay.includes(q);
  });
}

function renderInspections(){
  const all   = normalizeItems(DASH);
  const items = applyFilters(all, document.getElementById("q-aircraft").value);
  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  // Group by tail
  const byTail = new Map();
  items.forEach(it => {
    const t = safeStr(it.tail) || "UNKNOWN";
    if(!byTail.has(t)) byTail.set(t, []);
    byTail.get(t).push(it);
  });

  const tails = Array.from(byTail.keys()).sort((a,b) => {
    const sa = Math.min(...byTail.get(a).map(scoreItem));
    const sb = Math.min(...byTail.get(b).map(scoreItem));
    return sa - sb || a.localeCompare(b);
  });

  document.getElementById("empty-inspections").hidden = !!tails.length;

  tails.forEach(tail => {
    const list    = byTail.get(tail).slice().sort((x,y) => scoreItem(x)-scoreItem(y));
    const sevTop  = classifyItem(list[0]);
    const tt      = list[0].total_time;

    const card = document.createElement("div");
    card.className = "card";

    const rows = list.slice(0,12).map(it => {
      const sev  = classifyItem(it);
      const insp = safeStr(it.inspection || it.name || "Inspection");
      const ata  = safeStr(it.ata || "—");
      const due  = fmtDate(it.due_date);
      const d    = (it.remaining_days !== null && it.remaining_days !== undefined && !isNaN(Number(it.remaining_days))) ? Number(it.remaining_days) : null;
      const h    = (it.remaining_hours !== null && it.remaining_hours !== undefined && !isNaN(Number(it.remaining_hours))) ? Number(it.remaining_hours) : null;
      const metric = d !== null ? `${d}d` : h !== null ? `${h.toFixed(1)}h` : safeStr(it.status || "—").slice(0,18);
      const meta = [];
      if(ata && ata !== "—") meta.push(`<span class="mono-pill">ATA ${ata}</span>`);
      if(due !== "—") meta.push(`<span class="mono-pill">DUE ${due}</span>`);
      meta.push(`<span class="mono-pill">${metric}</span>`);
      return `<div class="item">
        <div class="bar ${barClass(sev)}"></div>
        <div class="item-main">
          <div class="item-title" title="${insp}">${insp}</div>
          <div class="item-meta">${meta.join(" ")}</div>
        </div>
        ${badgeFor(sev)}
      </div>`;
    }).join("");

    card.innerHTML = `
      <div class="card-header">
        <div class="card-tail">
          <span>${tail}</span>
          <span class="subline">${tt ? Number(tt).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1}) + " TT" : ""}</span>
        </div>
        ${badgeFor(sevTop)}
      </div>
      <div class="card-body">${rows}</div>`;
    cards.appendChild(card);
  });
}

// ---- ATA tab --------------------------------------------------------------
function renderAta(){
  const all = normalizeItems(DASH);
  const q   = document.getElementById("q-ata").value.trim().toLowerCase();
  const filtered = all.filter(it => {
    if(!q) return true;
    return [it.ata,it.inspection,it.tail].map(safeStr).join(" ").toLowerCase().includes(q);
  });

  const tbody = document.getElementById("ata-tbody");
  tbody.innerHTML = "";
  document.getElementById("empty-ata").hidden = !!filtered.length;
  if(!filtered.length) return;

  // Group by ATA
  const byAta = new Map();
  filtered.forEach(it => {
    const ata = safeStr(it.ata || "—");
    if(!byAta.has(ata)) byAta.set(ata, []);
    byAta.get(ata).push(it);
  });

  const groups = Array.from(byAta.entries());
  const groupScore = items => Math.min(...items.map(scoreItem));

  if(ataSortMode === "severity"){
    groups.sort((a,b) => groupScore(a[1]) - groupScore(b[1]) || a[0].localeCompare(b[0]));
  } else {
    groups.sort((a,b) => a[0].localeCompare(b[0]));
  }

  groups.forEach(([ata, items]) => {
    items.slice().sort((x,y) => scoreItem(x)-scoreItem(y)).forEach(it => {
      const sev  = classifyItem(it);
      const insp = safeStr(it.inspection || "Inspection");
      const tail = safeStr(it.tail || "—");
      const due  = fmtDate(it.due_date);
      const d    = (it.remaining_days !== null && it.remaining_days !== undefined && !isNaN(Number(it.remaining_days))) ? Number(it.remaining_days) : null;
      const h    = (it.remaining_hours !== null && it.remaining_hours !== undefined && !isNaN(Number(it.remaining_hours))) ? Number(it.remaining_hours) : null;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><span class="mono-pill">${ata}</span></td>
        <td>${insp}</td>
        <td><span class="mono-pill">${tail}</span></td>
        <td class="td-center">${badgeFor(sev)}</td>
        <td class="td-right">${d === null ? "—" : d}</td>
        <td class="td-right">${h === null ? "—" : h.toFixed(1)}</td>
        <td>${due}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// ---- Utilization tab ------------------------------------------------------
function renderUtilization(){
  const grid = document.getElementById("util-grid");
  grid.innerHTML = "";

  // Destroy old charts
  Object.values(utilCharts).forEach(c => c.destroy());
  Object.keys(utilCharts).forEach(k => delete utilCharts[k]);

  const aircraft = DASH?.aircraft || [];
  const withData = aircraft.filter(a => Array.isArray(a.daily_data) && a.daily_data.length >= 2);
  const noData   = aircraft.filter(a => !Array.isArray(a.daily_data) || a.daily_data.length < 2);

  document.getElementById("empty-util").hidden = !!(withData.length || noData.length);

  // Sort by tail
  const sorted = [...withData].sort((a,b) => a.tail.localeCompare(b.tail));

  sorted.forEach(ac => {
    const avg  = ac.avg_daily;
    const tt   = ac.airframe_hours;
    const data = ac.daily_data;

    // Compute daily deltas for bar chart
    const labels = [];
    const bars   = [];
    for(let i = 1; i < data.length; i++){
      const prev = data[i-1];
      const curr = data[i];
      const delta = Math.max(0, curr.hours - prev.hours);
      labels.push(curr.date.slice(5)); // MM-DD
      bars.push(parseFloat(delta.toFixed(2)));
    }

    const avgStr = avg !== null && avg !== undefined ? `${avg.toFixed(2)} hrs/day` : "—";
    const ttStr  = tt !== null && tt !== undefined ? Number(tt).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1}) : "—";
    const wkStr  = ac.projection_weekly !== null && ac.projection_weekly !== undefined ? ac.projection_weekly.toFixed(1) : "—";

    const card = document.createElement("div");
    card.className = "util-card";
    const canvasId = `chart-${ac.tail.replace(/\W/g,"_")}`;
    card.innerHTML = `
      <div class="util-card-header">
        <span class="util-tail">${ac.tail}</span>
        <span class="subline">${ttStr} TT</span>
      </div>
      <div class="util-stats">
        <div class="util-stat">
          <div class="util-stat-val">${avgStr}</div>
          <div class="util-stat-lbl">Avg Daily</div>
        </div>
        <div class="util-stat">
          <div class="util-stat-val">${wkStr} hrs</div>
          <div class="util-stat-lbl">Proj Weekly</div>
        </div>
        <div class="util-stat">
          <div class="util-stat-val">${data.length}</div>
          <div class="util-stat-lbl">Data Points</div>
        </div>
      </div>
      ${bars.length ? `<div class="util-chart-wrap"><canvas id="${canvasId}"></canvas></div>` : `<div class="util-no-data">Insufficient data for chart</div>`}`;
    grid.appendChild(card);

    if(bars.length){
      const ctx = document.getElementById(canvasId).getContext("2d");
      utilCharts[canvasId] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets:[{
            label: "Daily Hours",
            data: bars,
            backgroundColor: bars.map(v =>
              v <= 0 ? "rgba(74,85,104,0.3)" :
              v >= 5 ? "rgba(0,230,118,0.7)" :
              v >= 2 ? "rgba(41,182,246,0.7)" :
              "rgba(41,182,246,0.4)"
            ),
            borderRadius: 3,
            borderSkipped: false,
          }]
        },
        options:{
          responsive: true,
          maintainAspectRatio: false,
          plugins:{
            legend:{ display: false },
            datalabels:{
              color: "#cdd6e0",
              font:{ family:"'Share Tech Mono',monospace", size:9 },
              anchor:"end", align:"top",
              formatter: v => v > 0 ? v.toFixed(1) : "",
            },
            tooltip:{
              callbacks:{
                label: ctx => ` ${ctx.parsed.y.toFixed(2)} hrs flown`
              }
            }
          },
          scales:{
            x:{
              grid:{ color:"rgba(30,37,48,0.6)" },
              ticks:{ color:"#4a5568", font:{ family:"'Share Tech Mono',monospace", size:9 } }
            },
            y:{
              grid:{ color:"rgba(30,37,48,0.6)" },
              ticks:{ color:"#4a5568", font:{ family:"'Share Tech Mono',monospace", size:9 } },
              beginAtZero: true,
            }
          }
        },
        plugins:[ChartDataLabels]
      });
    }
  });

  // Aircraft with no data — show as a simple note
  if(noData.length){
    const section = document.createElement("div");
    section.className = "section-label";
    section.style.marginTop = "24px";
    section.textContent = "Insufficient History (≤1 data point)";
    grid.appendChild(section);

    const row = document.createElement("div");
    row.style.cssText = "display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;";
    noData.forEach(ac => {
      const pill = document.createElement("span");
      pill.className = "mono-pill";
      pill.style.cssText = "font-family:var(--mono);font-size:11px;padding:4px 10px;border:1px solid var(--border);border-radius:4px;color:var(--muted);";
      pill.textContent = ac.tail;
      row.appendChild(pill);
    });
    grid.appendChild(row);
  }
}

// ---- Master render --------------------------------------------------------
function renderAll(){
  const items = normalizeItems(DASH);
  renderSummary(items);
  renderInspections();
  renderAta();
  // Utilization renders on tab switch to avoid chart sizing issues
}

// ---- Load -----------------------------------------------------------------
async function loadDashboard(){
  const errorBox = document.getElementById("error-box");
  errorBox.hidden = true;
  try{
    const res = await fetch(DASHBOARD_URL + "?t=" + Date.now(), { cache: "no-store" });
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    DASH = await res.json();
    updateHeader(DASH.meta || {});
    renderAll();
  }catch(err){
    console.error(err);
    errorBox.hidden = false;
    errorBox.innerHTML = `
      <div style="font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Dashboard load failed</div>
      <div>Could not load <code>${DASHBOARD_URL}</code></div>
      <div style="margin-top:8px" class="small">${safeStr(err.message)}</div>`;
  }
}

document.getElementById("q-aircraft").addEventListener("input", () => renderInspections());
document.getElementById("q-ata").addEventListener("input", () => renderAta());

loadDashboard();
</script>
</body>
</html>
