<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IHC Health Services â€” Bell 407 Due Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    :root{
      --bg:#0a0c0f; --surface:#111418; --surface2:#181c22; --border:#1e2530;
      --green:#00e676; --amber:#ffab00; --red:#ff1744; --overdue:#ff6d00; --blue:#29b6f6;
      --text:#cdd6e0; --muted:#4a5568; --heading:#e8edf2;
      --mono:'Share Tech Mono',monospace; --sans:'Barlow Condensed',sans-serif; --body:'Barlow',sans-serif;
      --radius:6px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:var(--bg);color:var(--text);font-family:var(--body);min-height:100vh;overflow-x:hidden;}
    body::before{content:'';position:fixed;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);pointer-events:none;z-index:1000;}

    header{background:var(--surface);border-bottom:1px solid var(--border);padding:18px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;gap:16px;}
    .logo{font-family:var(--sans);font-weight:900;font-size:20px;letter-spacing:3px;color:var(--heading);text-transform:uppercase;line-height:1;}
    .logo span{color:var(--blue);}
    .subtitle{margin-top:6px;font-family:var(--mono);font-size:11px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;}
    .header-meta{font-family:var(--mono);font-size:11px;color:var(--muted);text-align:right;line-height:1.7;white-space:nowrap;}
    .header-meta .date{color:var(--blue);}

    main{max-width:1600px;margin:0 auto;padding:22px 28px 40px;}

    .legend{display:flex;flex-wrap:wrap;gap:16px;align-items:center;padding:10px 28px;background:var(--surface2);border-bottom:1px solid var(--border);font-family:var(--mono);font-size:11px;color:var(--muted);}
    .legend-item{display:flex;align-items:center;gap:8px;text-transform:uppercase;letter-spacing:1px;}
    .dot{width:8px;height:8px;border-radius:999px;}
    .dot-green{background:var(--green);box-shadow:0 0 6px var(--green);}
    .dot-amber{background:var(--amber);box-shadow:0 0 6px var(--amber);}
    .dot-red{background:var(--red);box-shadow:0 0 6px var(--red);}
    .dot-overdue{background:var(--overdue);box-shadow:0 0 6px var(--overdue);}

    .tabs{display:flex;gap:0;border-bottom:2px solid var(--border);margin-bottom:18px;flex-wrap:wrap;}
    .tab-btn{font-family:var(--sans);font-size:13px;font-weight:800;letter-spacing:2px;text-transform:uppercase;padding:12px 18px;background:transparent;border:none;color:var(--muted);cursor:pointer;transition:all .15s;border-bottom:3px solid transparent;}
    .tab-btn:hover{color:var(--text);background:rgba(255,255,255,0.02);}
    .tab-btn.active{color:var(--blue);border-bottom-color:var(--blue);}
    .tab-content{display:none;}
    .tab-content.active{display:block;}

    .summary-bar{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;}
    .summary-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 16px;min-width:160px;flex:0 0 auto;}
    .stat-value{font-family:var(--sans);font-size:30px;font-weight:900;line-height:1;margin-bottom:6px;color:var(--heading);}
    .stat-label{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;}
    .divider-line{width:42px;height:2px;border-radius:1px;margin:6px 0 8px;background:var(--border);}

    .section-label{font-family:var(--sans);font-size:11px;font-weight:700;letter-spacing:4px;text-transform:uppercase;color:var(--muted);margin:22px 0 10px;padding-bottom:6px;border-bottom:1px solid var(--border);}

    /* 12-month bar chart panel */
    .twelve-month-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 18px;margin-bottom:20px;}
    .twelve-month-title{font-family:var(--sans);font-size:11px;font-weight:700;letter-spacing:3px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
    .twelve-month-chart-wrap{position:relative;height:280px;}

    .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:10px 0 14px;}
    .search{flex:1 1 280px;min-width:240px;display:flex;gap:8px;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;}
    .search input{width:100%;background:transparent;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:12px;}
    .chip-row{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{font-family:var(--sans);font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase;padding:6px 12px;border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:999px;cursor:pointer;transition:.12s;}
    .chip:hover{color:var(--text);border-color:rgba(41,182,246,0.35);}
    .chip.active{background:var(--blue);border-color:var(--blue);color:#000;}

    .cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .card-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:12px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
    .card-tail{font-family:var(--sans);font-weight:900;font-size:18px;letter-spacing:1px;color:var(--heading);display:flex;align-items:baseline;gap:10px;min-width:0;}
    .subline{font-family:var(--mono);font-size:10px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;white-space:nowrap;}
    .badge{display:inline-flex;align-items:center;font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:4px 8px;border-radius:999px;border:1px solid var(--border);color:var(--muted);white-space:nowrap;flex:0 0 auto;}
    .b-overdue{color:var(--overdue);border-color:rgba(255,109,0,0.35);background:rgba(255,109,0,0.08);}
    .b-red{color:var(--red);border-color:rgba(255,23,68,0.35);background:rgba(255,23,68,0.08);}
    .b-amber{color:var(--amber);border-color:rgba(255,171,0,0.35);background:rgba(255,171,0,0.08);}
    .b-green{color:var(--green);border-color:rgba(0,230,118,0.35);background:rgba(0,230,118,0.06);}
    .b-blue{color:var(--blue);border-color:rgba(41,182,246,0.35);background:rgba(41,182,246,0.06);}
    .b-na{color:var(--muted);}

    .card-body{padding:12px 14px;}
    .item{display:flex;align-items:flex-start;gap:10px;padding:10px 0;border-bottom:1px solid rgba(30,37,48,0.7);}
    .item:last-child{border-bottom:none;}
    .bar{width:3px;height:34px;border-radius:2px;flex:0 0 auto;background:var(--border);margin-top:2px;}
    .bar.overdue{background:var(--overdue);box-shadow:0 0 10px rgba(255,109,0,0.25);}
    .bar.red{background:var(--red);}
    .bar.amber{background:var(--amber);}
    .bar.green{background:var(--green);}
    .bar.blue{background:var(--blue);}
    .item-main{min-width:0;flex:1 1 auto;}
    .item-title{font-family:var(--body);font-size:12px;font-weight:600;color:var(--text);line-height:1.25;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-meta{margin-top:4px;font-family:var(--mono);font-size:10px;color:var(--muted);display:flex;gap:10px;flex-wrap:wrap;}
    .mono-pill{border:1px solid rgba(74,85,104,0.35);padding:2px 6px;border-radius:4px;letter-spacing:.5px;text-transform:uppercase;}

    /* Components tab table */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);}
    table{width:100%;border-collapse:collapse;font-family:var(--mono);font-size:12px;min-width:760px;}
    thead th{background:var(--surface2);color:var(--muted);font-family:var(--sans);font-weight:800;letter-spacing:2px;text-transform:uppercase;font-size:11px;padding:10px 12px;text-align:left;border-bottom:1px solid var(--border);white-space:nowrap;}
    tbody td{padding:10px 12px;border-bottom:1px solid rgba(30,37,48,0.7);vertical-align:middle;}
    tbody tr:hover{background:rgba(255,255,255,0.02);}
    .td-right{text-align:right;}
    .td-center{text-align:center;}

    /* Horizontal hours-remaining bar inside table */
    .hrs-bar-wrap{display:flex;align-items:center;gap:8px;}
    .hrs-bar-bg{flex:1;height:6px;background:var(--border);border-radius:3px;min-width:80px;max-width:160px;}
    .hrs-bar-fill{height:6px;border-radius:3px;transition:width .3s;}
    .hrs-val{font-family:var(--mono);font-size:11px;white-space:nowrap;min-width:44px;text-align:right;}

    /* Utilization tab */
    .util-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:14px;}
    .util-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;}
    .util-card-header{background:var(--surface2);border-bottom:1px solid var(--border);padding:10px 14px;display:flex;justify-content:space-between;align-items:center;}
    .util-tail{font-family:var(--sans);font-weight:900;font-size:16px;letter-spacing:1px;color:var(--heading);}
    .util-stats{display:flex;gap:18px;padding:10px 14px;border-bottom:1px solid var(--border);}
    .util-stat{text-align:center;}
    .util-stat-val{font-family:var(--sans);font-size:18px;font-weight:900;color:var(--blue);}
    .util-stat-lbl{font-family:var(--mono);font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:2px;}
    .util-chart-wrap{padding:10px 14px;position:relative;height:140px;}
    .util-no-data{padding:20px 14px;font-family:var(--mono);font-size:11px;color:var(--muted);text-align:center;}

    .empty{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;font-family:var(--mono);color:var(--muted);font-size:12px;}
    footer{margin-top:38px;padding:16px 28px;border-top:1px solid var(--border);font-family:var(--mono);font-size:10px;color:var(--muted);display:flex;justify-content:space-between;letter-spacing:1px;flex-wrap:wrap;gap:10px;}
    .errbar{border:1px solid rgba(255,23,68,0.35);background:rgba(255,23,68,0.08);color:var(--red);padding:10px 12px;border-radius:var(--radius);font-family:var(--mono);font-size:12px;margin:14px 0;}
    code{font-family:var(--mono);}
    @media(max-width:720px){header{padding:16px 18px;}main{padding:18px 18px 36px;}}
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">IHC <span>HEALTH</span> SERVICES</div>
    <div class="subtitle">Bell 407 Fleet â€” Inspections &amp; Due List</div>
  </div>
  <div class="header-meta">
    <div class="date" id="hdr-report-date">REPORT DATE: â€”</div>
    <div id="hdr-generated">GENERATED: â€”</div>
    <div id="hdr-source" class="small">SOURCE: data/dashboard.json</div>
  </div>
</header>

<div class="legend">
  <div class="legend-item"><div class="dot dot-green"></div> OK</div>
  <div class="legend-item"><div class="dot dot-amber"></div> Coming Due</div>
  <div class="legend-item"><div class="dot dot-red"></div> Critical</div>
  <div class="legend-item"><div class="dot dot-overdue"></div> Overdue</div>
  <div style="margin-left:auto">Date-driven items use <b>days remaining</b> first. Hour-driven items use <b>hours remaining</b>.</div>
</div>

<main>
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('inspections',this)">Inspections</button>
    <button class="tab-btn" onclick="switchTab('components',this)">Components</button>
    <button class="tab-btn" onclick="switchTab('utilization',this)">Utilization</button>
  </div>

  <div class="summary-bar">
    <div class="summary-stat">
      <div class="stat-value" id="sum-overdue" style="color:var(--overdue)">â€”</div>
      <div class="divider-line" style="background:var(--overdue)"></div>
      <div class="stat-label">Overdue</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-critical" style="color:var(--red)">â€”</div>
      <div class="divider-line" style="background:var(--red)"></div>
      <div class="stat-label">Critical</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-coming" style="color:var(--amber)">â€”</div>
      <div class="divider-line" style="background:var(--amber)"></div>
      <div class="stat-label">Coming Due</div>
    </div>
    <div class="summary-stat">
      <div class="stat-value" id="sum-tracked" style="color:var(--blue)">â€”</div>
      <div class="divider-line" style="background:var(--blue)"></div>
      <div class="stat-label">Tracked Items</div>
    </div>
  </div>

  <div id="error-box" class="errbar" hidden></div>

  <!-- INSPECTIONS TAB -->
  <div id="tab-inspections" class="tab-content active">

    <!-- 12-Month inspection bar chart -->
    <div class="twelve-month-panel" id="twelve-month-panel" hidden>
      <div class="twelve-month-title">Weeks Remaining â€” 12 Month Inspection</div>
      <div class="twelve-month-chart-wrap">
        <canvas id="twelve-month-chart"></canvas>
      </div>
    </div>

    <div class="toolbar">
      <div class="search">
        <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">FILTER</span>
        <input id="q-aircraft" placeholder="Search tail, inspection name, or ATAâ€¦" autocomplete="off" />
      </div>
      <div class="chip-row" id="severity-chips">
        <button class="chip active" onclick="setSeverityFilter('all',this)">All</button>
        <button class="chip" onclick="setSeverityFilter('overdue',this)">Overdue</button>
        <button class="chip" onclick="setSeverityFilter('critical',this)">Critical</button>
        <button class="chip" onclick="setSeverityFilter('coming',this)">Coming</button>
        <button class="chip" onclick="setSeverityFilter('ok',this)">OK</button>
      </div>
    </div>
    <div class="section-label">Inspections by Aircraft</div>
    <div id="cards" class="cards"></div>
    <div id="empty-inspections" class="empty" hidden>No tracked inspection items found.</div>
  </div>

  <!-- COMPONENTS TAB -->
  <div id="tab-components" class="tab-content">
    <div class="toolbar">
      <div class="search">
        <span style="color:var(--muted);font-family:var(--mono);font-size:11px;">FILTER</span>
        <input id="q-comp" placeholder="Search tail, component, or ATAâ€¦" autocomplete="off" />
      </div>
      <div class="chip-row" id="comp-window-chips">
        <button class="chip active" onclick="setCompWindow(200,this)">â‰¤200 hrs</button>
        <button class="chip" onclick="setCompWindow(100,this)">â‰¤100 hrs</button>
        <button class="chip" onclick="setCompWindow(50,this)">â‰¤50 hrs</button>
        <button class="chip" onclick="setCompWindow(9999,this)">All</button>
      </div>
    </div>
    <div class="section-label">Components Due Retire / Overhaul</div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Aircraft</th>
            <th>ATA</th>
            <th>Component</th>
            <th>Type</th>
            <th class="td-right">Hours Remaining</th>
          </tr>
        </thead>
        <tbody id="comp-tbody"></tbody>
      </table>
    </div>
    <div id="empty-comp" class="empty" hidden style="margin-top:12px;">No components found within selected window.</div>
  </div>

  <!-- UTILIZATION TAB -->
  <div id="tab-utilization" class="tab-content">
    <div class="section-label">Fleet Utilization â€” Daily Flight Hours</div>
    <div id="util-grid" class="util-grid"></div>
    <div id="empty-util" class="empty" hidden>No utilization data available yet.</div>
  </div>
</main>

<footer>
  <span>IHC Health Services â€” Bell 407 Dashboard</span>
  <span id="ftr-right">â€”</span>
</footer>

<script>
Chart.register(ChartDataLabels);

const DASHBOARD_URL = "data/dashboard.json";
let DASH = null;
let RAW_COMP = [];        // raw component rows from dashboard.json
let severityFilter = "all";
let compWindow = 200;
let twelveMonthChart = null;
const utilCharts = {};

// ---- Tab switching --------------------------------------------------------
function switchTab(name, btn){
  document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
  document.getElementById("tab-" + name).classList.add("active");
  if(name === "utilization") renderUtilization();
  if(name === "components")  renderComponents();
}

// ---- Helpers --------------------------------------------------------------
function safeStr(x){ return (x===null||x===undefined) ? "" : String(x); }
function fmtDate(d){
  if(!d) return "â€”";
  const dt = new Date(d + "T00:00:00");
  if(isNaN(dt)) return "â€”";
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,"0")}-${String(dt.getDate()).padStart(2,"0")}`;
}

// ---- Normalize inspection items from aircraft array ----------------------
function normalizeItems(dash){
  const out = [];
  if(!Array.isArray(dash.aircraft)) return out;
  dash.aircraft.forEach(a => {
    const tail = a.tail || "";
    const tt   = a.airframe_hours;
    (a.items || []).forEach(it => out.push({ tail, total_time: tt, ...it }));
  });
  return out;
}

// ---- Classification -------------------------------------------------------
function classifyItem(item){
  const d = item.remaining_days;
  if(d !== null && d !== undefined && d !== "" && !isNaN(Number(d))){
    const v = Number(d);
    if(v < 0)   return "overdue";
    if(v <= 7)  return "critical";
    if(v <= 30) return "coming";
    return "ok";
  }
  const h = item.remaining_hours;
  if(h !== null && h !== undefined && h !== "" && !isNaN(Number(h))){
    const v = Number(h);
    if(v < 0)    return "overdue";
    if(v <= 25)  return "critical";
    if(v <= 100) return "coming";
    return "ok";
  }
  const s = safeStr(item.status || item.next_due_status).toUpperCase();
  if(s.includes("PAST DUE")||s.includes("OVERDUE")) return "overdue";
  if(s.includes("CRITICAL"))  return "critical";
  if(s.includes("COMING"))    return "coming";
  if(s.includes("OK"))        return "ok";
  return "na";
}

function scoreItem(item){
  const sev = classifyItem(item);
  const d = Number(item.remaining_days);
  const h = Number(item.remaining_hours);
  if(sev==="overdue")  return !isNaN(d) ? -100000+d : !isNaN(h) ? -90000+h : -80000;
  if(sev==="critical") return !isNaN(d) ? d         : !isNaN(h) ?  2000+h  :  5000;
  if(sev==="coming")   return !isNaN(d) ? 10000+d   : !isNaN(h) ? 14000+h  : 18000;
  if(sev==="ok")       return !isNaN(d) ? 20000+d   : !isNaN(h) ? 24000+h  : 28000;
  return 99999;
}

function badgeFor(sev){
  if(sev==="overdue")  return `<span class="badge b-overdue">OVERDUE</span>`;
  if(sev==="critical") return `<span class="badge b-red">CRITICAL</span>`;
  if(sev==="coming")   return `<span class="badge b-amber">COMING</span>`;
  if(sev==="ok")       return `<span class="badge b-green">OK</span>`;
  return `<span class="badge b-na">â€”</span>`;
}

function barClass(sev){
  return {overdue:"overdue",critical:"red",coming:"amber",ok:"green"}[sev]||"";
}

// ---- Component severity (hours only) -------------------------------------
function classifyHours(h){
  if(h === null || h === undefined || isNaN(h)) return "na";
  if(h < 0)    return "overdue";
  if(h <= 25)  return "critical";
  if(h <= 100) return "coming";
  return "ok";
}

// ---- Summary counts -------------------------------------------------------
function renderSummary(items){
  let overdue=0,critical=0,coming=0,tracked=0;
  items.forEach(it => {
    const sev = classifyItem(it);
    if(sev==="na") return;
    tracked++;
    if(sev==="overdue")  overdue++;
    else if(sev==="critical") critical++;
    else if(sev==="coming")   coming++;
  });
  document.getElementById("sum-overdue").textContent  = overdue;
  document.getElementById("sum-critical").textContent = critical;
  document.getElementById("sum-coming").textContent   = coming;
  document.getElementById("sum-tracked").textContent  = tracked;
}

// ---- Header ---------------------------------------------------------------
function updateHeader(meta){
  document.getElementById("hdr-report-date").textContent = `REPORT DATE: ${meta?.report_date||"â€”"}`;
  document.getElementById("hdr-generated").textContent   = `GENERATED: ${meta?.generated_utc||"â€”"}`;
  document.getElementById("hdr-source").textContent      = `SOURCE: ${meta?.source||"data/dashboard.json"}`;
  document.getElementById("ftr-right").textContent       = `Last update: ${meta?.generated_utc||"â€”"}`;
}

// ---- 12-Month bar chart ---------------------------------------------------
function render12MonthChart(items){
  // Pull 12 Month inspection items only
  const twelveItems = items
    .filter(it => safeStr(it.inspection).toUpperCase().includes("12 MONTH"))
    .filter(it => it.remaining_days !== null && it.remaining_days !== undefined && !isNaN(Number(it.remaining_days)));

  const panel = document.getElementById("twelve-month-panel");
  if(!twelveItems.length){ panel.hidden = true; return; }
  panel.hidden = false;

  // Sort by weeks remaining ascending (most urgent first)
  twelveItems.sort((a,b) => Number(a.remaining_days) - Number(b.remaining_days));

  const labels = twelveItems.map(it => it.tail);
  const weeks  = twelveItems.map(it => parseFloat((Number(it.remaining_days)/7).toFixed(1)));

  const colors = weeks.map(w => {
    if(w < 0)   return "rgba(255,109,0,0.85)";   // overdue
    if(w <= 1)  return "rgba(255,23,68,0.85)";    // critical <1 week
    if(w <= 4)  return "rgba(255,171,0,0.85)";    // coming â‰¤4 weeks
    return "rgba(41,182,246,0.7)";                // ok
  });

  if(twelveMonthChart){ twelveMonthChart.destroy(); twelveMonthChart = null; }

  const ctx = document.getElementById("twelve-month-chart").getContext("2d");
  twelveMonthChart = new Chart(ctx, {
    type: "bar",
    data:{
      labels,
      datasets:[{
        label:"Weeks Remaining",
        data: weeks,
        backgroundColor: colors,
        borderRadius: 4,
        borderSkipped: false,
      }]
    },
    options:{
      indexAxis: "y",
      responsive: true,
      maintainAspectRatio: false,
      plugins:{
        legend:{ display:false },
        datalabels:{
          color:"#cdd6e0",
          font:{ family:"'Share Tech Mono',monospace", size:10 },
          anchor:"end", align:"right",
          formatter: v => v < 0 ? `${Math.abs(v).toFixed(1)}w OVERDUE` : `${v}w`,
        },
        tooltip:{
          callbacks:{
            label: ctx => {
              const w = ctx.parsed.x;
              const d = Math.round(w * 7);
              return w < 0 ? ` ${Math.abs(d)} days overdue` : ` ${d} days (${w} weeks)`;
            }
          }
        }
      },
      scales:{
        x:{
          grid:{ color:"rgba(30,37,48,0.6)" },
          ticks:{ color:"#4a5568", font:{ family:"'Share Tech Mono',monospace", size:9 },
            callback: v => `${v}w` },
          title:{ display:true, text:"Weeks Remaining", color:"#4a5568",
            font:{ family:"'Barlow Condensed',sans-serif", size:11, weight:"700" } }
        },
        y:{
          grid:{ display:false },
          ticks:{ color:"#cdd6e0", font:{ family:"'Share Tech Mono',monospace", size:11 } }
        }
      },
      layout:{ padding:{ right:70 } }
    },
    plugins:[ChartDataLabels]
  });
}

// ---- Inspections tab ------------------------------------------------------
function setSeverityFilter(val, btn){
  severityFilter = val;
  document.querySelectorAll("#severity-chips .chip").forEach(c => c.classList.remove("active"));
  btn.classList.add("active");
  renderInspections();
}

function renderInspections(){
  const all = normalizeItems(DASH);
  const q   = document.getElementById("q-aircraft").value.trim().toLowerCase();

  const filtered = all.filter(it => {
    const sev = classifyItem(it);
    if(severityFilter !== "all" && severityFilter !== sev) return false;
    if(!q) return true;
    return [it.tail,it.inspection,it.ata,it.status,it.due_date].map(safeStr).join(" ").toLowerCase().includes(q);
  });

  const cards = document.getElementById("cards");
  cards.innerHTML = "";

  const byTail = new Map();
  filtered.forEach(it => {
    const t = safeStr(it.tail)||"UNKNOWN";
    if(!byTail.has(t)) byTail.set(t,[]);
    byTail.get(t).push(it);
  });

  const tails = Array.from(byTail.keys()).sort((a,b)=>{
    const sa = Math.min(...byTail.get(a).map(scoreItem));
    const sb = Math.min(...byTail.get(b).map(scoreItem));
    return sa-sb||a.localeCompare(b);
  });

  document.getElementById("empty-inspections").hidden = !!tails.length;

  tails.forEach(tail => {
    const list   = byTail.get(tail).slice().sort((x,y)=>scoreItem(x)-scoreItem(y));
    const sevTop = classifyItem(list[0]);
    const tt     = list[0].total_time;

    const rows = list.slice(0,12).map(it => {
      const sev  = classifyItem(it);
      const insp = safeStr(it.inspection||"Inspection");
      const ata  = safeStr(it.ata||"â€”");
      const due  = fmtDate(it.due_date);
      const d = (it.remaining_days!==null&&it.remaining_days!==undefined&&!isNaN(Number(it.remaining_days)))?Number(it.remaining_days):null;
      const h = (it.remaining_hours!==null&&it.remaining_hours!==undefined&&!isNaN(Number(it.remaining_hours)))?Number(it.remaining_hours):null;
      const metric = d!==null ? `${d}d` : h!==null ? `${h.toFixed(1)}h` : safeStr(it.status||"â€”").slice(0,18);
      const meta = [];
      if(ata&&ata!=="â€”") meta.push(`<span class="mono-pill">ATA ${ata}</span>`);
      if(due!=="â€”") meta.push(`<span class="mono-pill">DUE ${due}</span>`);
      meta.push(`<span class="mono-pill">${metric}</span>`);
      return `<div class="item">
        <div class="bar ${barClass(sev)}"></div>
        <div class="item-main">
          <div class="item-title" title="${insp}">${insp}</div>
          <div class="item-meta">${meta.join(" ")}</div>
        </div>
        ${badgeFor(sev)}
      </div>`;
    }).join("");

    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div class="card-header">
        <div class="card-tail">
          <span>${tail}</span>
          <span class="subline">${tt?Number(tt).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})+" TT":""}</span>
        </div>
        ${badgeFor(sevTop)}
      </div>
      <div class="card-body">${rows}</div>`;
    cards.appendChild(card);
  });
}

// ---- Components tab -------------------------------------------------------
function setCompWindow(w, btn){
  compWindow = w;
  document.querySelectorAll("#comp-window-chips .chip").forEach(c => c.classList.remove("active"));
  btn.classList.add("active");
  renderComponents();
}

function renderComponents(){
  const q = document.getElementById("q-comp").value.trim().toLowerCase();

  const filtered = RAW_COMP.filter(c => {
    const h = Number(c.remaining_hours);
    if(compWindow < 9999 && (!isFinite(h) || h > compWindow)) return false;
    if(!q) return true;
    return [c.tail, c.ata, c.description, c.item_type, c.label].map(safeStr).join(" ").toLowerCase().includes(q);
  }).sort((a,b) => {
    const ha = isFinite(Number(a.remaining_hours)) ? Number(a.remaining_hours) : 99999;
    const hb = isFinite(Number(b.remaining_hours)) ? Number(b.remaining_hours) : 99999;
    return ha - hb || a.tail.localeCompare(b.tail);
  });

  const tbody = document.getElementById("comp-tbody");
  tbody.innerHTML = "";
  document.getElementById("empty-comp").hidden = !!filtered.length;
  if(!filtered.length) return;

  // Max hours for scaling the inline bar (use 200 as reference)
  const maxH = Math.max(200, ...filtered.map(c => Number(c.remaining_hours)||0));

  filtered.forEach(c => {
    const h    = isFinite(Number(c.remaining_hours)) ? Number(c.remaining_hours) : null;
    const sev  = classifyHours(h);
    const pct  = h !== null ? Math.min(100, Math.max(0, (h / maxH) * 100)) : 0;
    const color = {overdue:"var(--overdue)",critical:"var(--red)",coming:"var(--amber)",ok:"var(--green)"}[sev]||"var(--muted)";
    const hStr = h !== null ? h.toFixed(1) : "â€”";

    // Determine label: RETIRE or OVERHAUL from description
    const desc = safeStr(c.description).toUpperCase();
    const label = desc.includes("RETIRE") ? "RETIRE" :
                  desc.includes("OVERHAUL") ? "OVERHAUL" :
                  desc.includes("LIMIT") ? "LIMIT" :
                  safeStr(c.item_type);

    const badgeCls = {RETIRE:"b-overdue",OVERHAUL:"b-amber",LIMIT:"b-red"}[label]||"b-blue";

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><span class="mono-pill">${c.tail}</span></td>
      <td><span class="mono-pill">${safeStr(c.ata)||"â€”"}</span></td>
      <td style="max-width:340px;white-space:normal;line-height:1.3;">${safeStr(c.description)}</td>
      <td class="td-center"><span class="badge ${badgeCls}">${label}</span></td>
      <td class="td-right">
        <div class="hrs-bar-wrap">
          <div class="hrs-bar-bg"><div class="hrs-bar-fill" style="width:${pct}%;background:${color};"></div></div>
          <span class="hrs-val" style="color:${color}">${hStr} hrs</span>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

// ---- Utilization tab ------------------------------------------------------
function renderUtilization(){
  const grid = document.getElementById("util-grid");
  grid.innerHTML = "";
  Object.values(utilCharts).forEach(c => c.destroy());
  Object.keys(utilCharts).forEach(k => delete utilCharts[k]);

  const aircraft = DASH?.aircraft || [];
  const withData = aircraft.filter(a => Array.isArray(a.daily_data) && a.daily_data.length >= 2)
                           .sort((a,b)=>a.tail.localeCompare(b.tail));
  const noData   = aircraft.filter(a => !Array.isArray(a.daily_data) || a.daily_data.length < 2);

  document.getElementById("empty-util").hidden = !!(withData.length||noData.length);

  withData.forEach(ac => {
    const avg  = ac.avg_daily;
    const tt   = ac.airframe_hours;
    const data = ac.daily_data;
    const labels=[], bars=[];
    for(let i=1;i<data.length;i++){
      labels.push(data[i].date.slice(5));
      bars.push(parseFloat(Math.max(0,data[i].hours-data[i-1].hours).toFixed(2)));
    }
    const avgStr = avg!=null ? `${avg.toFixed(2)} hrs/day` : "â€”";
    const ttStr  = tt!=null  ? Number(tt).toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1}) : "â€”";
    const wkStr  = ac.projection_weekly!=null ? ac.projection_weekly.toFixed(1) : "â€”";
    const canvasId = `chart-${ac.tail.replace(/\W/g,"_")}`;

    const card = document.createElement("div");
    card.className = "util-card";
    card.innerHTML = `
      <div class="util-card-header">
        <span class="util-tail">${ac.tail}</span>
        <span class="subline">${ttStr} TT</span>
      </div>
      <div class="util-stats">
        <div class="util-stat"><div class="util-stat-val">${avgStr}</div><div class="util-stat-lbl">Avg Daily</div></div>
        <div class="util-stat"><div class="util-stat-val">${wkStr} hrs</div><div class="util-stat-lbl">Proj Weekly</div></div>
        <div class="util-stat"><div class="util-stat-val">${data.length}</div><div class="util-stat-lbl">Data Points</div></div>
      </div>
      ${bars.length ? `<div class="util-chart-wrap"><canvas id="${canvasId}"></canvas></div>` : `<div class="util-no-data">Insufficient data for chart</div>`}`;
    grid.appendChild(card);

    if(bars.length){
      const ctx = document.getElementById(canvasId).getContext("2d");
      utilCharts[canvasId] = new Chart(ctx,{
        type:"bar",
        data:{labels,datasets:[{label:"Daily Hours",data:bars,
          backgroundColor:bars.map(v=>v<=0?"rgba(74,85,104,0.3)":v>=5?"rgba(0,230,118,0.7)":v>=2?"rgba(41,182,246,0.7)":"rgba(41,182,246,0.4)"),
          borderRadius:3,borderSkipped:false}]},
        options:{responsive:true,maintainAspectRatio:false,
          plugins:{legend:{display:false},
            datalabels:{color:"#cdd6e0",font:{family:"'Share Tech Mono',monospace",size:9},anchor:"end",align:"top",formatter:v=>v>0?v.toFixed(1):""},
            tooltip:{callbacks:{label:ctx=>` ${ctx.parsed.y.toFixed(2)} hrs`}}},
          scales:{
            x:{grid:{color:"rgba(30,37,48,0.6)"},ticks:{color:"#4a5568",font:{family:"'Share Tech Mono',monospace",size:9}}},
            y:{grid:{color:"rgba(30,37,48,0.6)"},ticks:{color:"#4a5568",font:{family:"'Share Tech Mono',monospace",size:9}},beginAtZero:true}
          }},
        plugins:[ChartDataLabels]
      });
    }
  });

  if(noData.length){
    const section = document.createElement("div");
    section.className="section-label";
    section.style.marginTop="24px";
    section.textContent="Insufficient History (â‰¤1 data point)";
    grid.appendChild(section);
    const row = document.createElement("div");
    row.style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;";
    noData.forEach(ac=>{
      const pill=document.createElement("span");
      pill.className="mono-pill";
      pill.style="font-family:var(--mono);font-size:11px;padding:4px 10px;border:1px solid var(--border);border-radius:4px;color:var(--muted);";
      pill.textContent=ac.tail;
      row.appendChild(pill);
    });
    grid.appendChild(row);
  }
}

// ---- Load data ------------------------------------------------------------
async function loadDashboard(){
  const errorBox = document.getElementById("error-box");
  errorBox.hidden = true;
  try{
    const res = await fetch(DASHBOARD_URL+"?t="+Date.now(),{cache:"no-store"});
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    DASH = await res.json();

    // Pre-build component list from dashboard.json components array
    RAW_COMP = Array.isArray(DASH.components) ? DASH.components : [];

    updateHeader(DASH.meta||{});
    const items = normalizeItems(DASH);
    renderSummary(items);
    render12MonthChart(items);
    renderInspections();
  }catch(err){
    console.error(err);
    errorBox.hidden=false;
    errorBox.innerHTML=`
      <div style="font-weight:700;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px;">Dashboard load failed</div>
      <div>Could not load <code>${DASHBOARD_URL}</code></div>
      <div style="margin-top:8px;font-size:10px;">${safeStr(err.message)}</div>`;
  }
}

document.getElementById("q-aircraft").addEventListener("input",()=>renderInspections());
document.getElementById("q-comp").addEventListener("input",()=>renderComponents());

loadDashboard();
</script>

<!-- ========== MERLIN ========== -->
<div id="merlin-wrap" style="position:fixed;bottom:24px;right:24px;z-index:9999;user-select:none;">
  <div id="merlin-bubble" style="
    display:none;position:absolute;bottom:130px;right:0;
    background:#0d1117;border:1px solid #29b6f6;border-radius:8px 8px 0 8px;
    padding:12px 14px;max-width:260px;min-width:180px;
    font-family:'Share Tech Mono',monospace;font-size:12px;line-height:1.55;
    color:#cdd6e0;box-shadow:0 0 20px rgba(41,182,246,0.15);
  ">
    <div id="merlin-text"></div>
    <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;" id="merlin-btns"></div>
  </div>
  <img id="merlin-img" src="https://cdn.jsdelivr.net/npm/clippyjs/dist/agents/Merlin/map.png"
    style="width:80px;height:80px;cursor:pointer;image-rendering:pixelated;filter:drop-shadow(0 0 8px rgba(41,182,246,0.4));"
    title="Merlin â€” click me, cher!"
    onerror="this.style.display='none';document.getElementById('merlin-fallback').style.display='block'"
  />
  <div id="merlin-fallback" style="display:none;width:80px;height:80px;background:var(--surface);border:1px solid var(--border);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;" onclick="merlinClick()">ðŸ§™</div>
</div>

<script>
// ---- Merlin the Creole wizard --------------------------------------------

function merlinTTS(text) {
  if (typeof speechSynthesis === "undefined") return;
  speechSynthesis.cancel();

  function speak() {
    const utter = new SpeechSynthesisUtterance(text);
    const voices = speechSynthesis.getVoices();
    const preferred =
      voices.find(v => v.name === "Microsoft David Desktop - English (United States)") ||
      voices.find(v => v.name.includes("David")) ||
      voices.find(v => v.name.includes("Mark"))  ||
      voices.find(v => v.lang === "en-US" && v.name.toLowerCase().includes("male")) ||
      voices.find(v => v.lang === "en-US") ||
      voices[0];
    if (preferred) utter.voice = preferred;
    utter.rate   = 0.68;
    utter.pitch  = 0.55;
    utter.volume = 1.0;
    currentUtterance = utter;
    speechSynthesis.speak(utter);
  }

  if (speechSynthesis.getVoices().length) {
    speak();
  } else {
    speechSynthesis.onvoiceschanged = () => { speechSynthesis.onvoiceschanged = null; speak(); };
  }
}


let merlinSpeaking = false;
let merlinQueue = [];
let currentUtterance = null;

const MERLIN_LINES = {
  greeting: [
    "Oh. You opened the dashboard. Congratulations. Let me tell you what you've already missed.",
    "Welcome back. I've been sitting here watching these numbers get worse. Hope you had a nice break.",
    "Merlin here. I've memorized every overdue item on this fleet. Would you like to feel bad about that? Click me.",
  ],
  overdue: (tail, insp) =>
    `${tail} is overdue on the ${insp}. It was overdue yesterday too. And the day before. Just thought you should know.`,
  critical: (tail, insp, days) =>
    `${tail} has ${days} days until the ${insp}. ${days} days. That's not a lot of days. I'm not panicking. You should be panicking.`,
  allGood:
    "Nothing is critically overdue right now. Don't worry, I'm sure that won't last. Check back in a few days.",
  components: (tail, desc, hrs) =>
    `${tail} has ${hrs.toFixed(0)} hours left on the ${desc}. ${hrs.toFixed(0)}. I'll just leave that there.`,
  manyIssues: (n) =>
    `There are ${n} items requiring attention on this fleet. ${n}. I've counted them several times hoping the number would change. It hasn't.`,
  idle: [
    "Still here. Still watching. The Components tab has some things in it you probably don't want to see.",
    "I'm not saying anyone is behind on maintenance. I'm just saying I've seen the numbers and I have concerns.",
    "Fun fact: N307KH has more airframe hours than most wizards have birthdays. Something to think about.",
    "Have you checked the Components tab lately? No? Interesting choice.",
    "I computed the fleet utilization again. For fun. I need you to look at it.",
  ],
};

function merlinSpeak(text, opts = {}) {
  const bubble = document.getElementById("merlin-bubble");
  const textEl = document.getElementById("merlin-text");
  const btnsEl = document.getElementById("merlin-btns");

  // Cancel current speech
  if (currentUtterance) { currentUtterance.pause && currentUtterance.pause(); currentUtterance = null; }

  // Show bubble
  bubble.style.display = "block";
  btnsEl.innerHTML = "";

  // Typewriter effect
  textEl.textContent = "";
  let i = 0;
  const interval = setInterval(() => {
    textEl.textContent += text[i] || "";
    i++;
    if (i >= text.length) {
      clearInterval(interval);
      // Add dismiss button
      const btn = document.createElement("button");
      btn.textContent = "A'ight, cher";
      btn.style.cssText = "background:transparent;border:1px solid #29b6f6;color:#29b6f6;font-family:'Share Tech Mono',monospace;font-size:10px;padding:4px 8px;border-radius:4px;cursor:pointer;";
      btn.onclick = merlinDismiss;
      btnsEl.appendChild(btn);

      // Add "Tell me more" if callback provided
      if (opts.more) {
        const btn2 = document.createElement("button");
        btn2.textContent = "Tell me more, yeah";
        btn2.style.cssText = "background:transparent;border:1px solid rgba(41,182,246,0.4);color:#4a5568;font-family:'Share Tech Mono',monospace;font-size:10px;padding:4px 8px;border-radius:4px;cursor:pointer;";
        btn2.onclick = opts.more;
        btnsEl.appendChild(btn2);
      }
    }
  }, 28);

  // TTS
  merlinTTS(text);

  // Auto-dismiss after a while
  if (!opts.persist) {
    setTimeout(() => {
      if (bubble.style.display !== "none") merlinDismiss();
    }, Math.max(6000, text.length * 60));
  }
}

function merlinDismiss() {
  document.getElementById("merlin-bubble").style.display = "none";
  if (currentUtterance) { currentUtterance.pause && currentUtterance.pause(); currentUtterance = null; }
}

function merlinClick() {
  if (document.getElementById("merlin-bubble").style.display !== "none") {
    merlinDismiss();
    return;
  }
  merlinBriefing();
}
document.getElementById("merlin-img").onclick = merlinClick;

function merlinBriefing() {
  if (!DASH) {
    merlinSpeak("Mais cher, da data ain't loaded yet, yeah. Give Merlin a moment, him.");
    return;
  }

  const items = [];
  (DASH.aircraft || []).forEach(a => {
    (a.items || []).forEach(it => items.push({ tail: a.tail, ...it }));
  });

  const overdue  = items.filter(it => (it.remaining_days !== null && Number(it.remaining_days) < 0) ||
                                       it.status === "OVERDUE");
  const critical = items.filter(it => {
    const d = Number(it.remaining_days);
    return !isNaN(d) && d >= 0 && d <= 7;
  });
  const components200 = (DASH.components || []).filter(c => c.remaining_hours <= 50);

  if (overdue.length) {
    const o = overdue[0];
    const moreIdx = [1];
    merlinSpeak(MERLIN_LINES.overdue(o.tail, o.inspection), {
      more: overdue.length > 1 ? () => {
        const o2 = overdue[moreIdx[0]++ % overdue.length];
        merlinSpeak(MERLIN_LINES.overdue(o2.tail, o2.inspection));
      } : null
    });
  } else if (critical.length >= 3) {
    merlinSpeak(MERLIN_LINES.manyIssues(critical.length), {
      more: () => {
        const c = critical[Math.floor(Math.random() * critical.length)];
        merlinSpeak(MERLIN_LINES.critical(c.tail, c.inspection, Number(c.remaining_days)));
      }
    });
  } else if (critical.length) {
    const c = critical[0];
    merlinSpeak(MERLIN_LINES.critical(c.tail, c.inspection, Number(c.remaining_days)), {
      more: components200.length ? () => {
        const comp = components200[0];
        merlinSpeak(MERLIN_LINES.components(comp.tail, comp.description, comp.remaining_hours));
      } : null
    });
  } else if (components200.length) {
    const comp = components200[0];
    merlinSpeak(MERLIN_LINES.components(comp.tail, comp.description, comp.remaining_hours));
  } else {
    merlinSpeak(MERLIN_LINES.allGood);
  }
}

// Greet on load after data is ready
function merlinGreet() {
  const line = MERLIN_LINES.greeting[Math.floor(Math.random() * MERLIN_LINES.greeting.length)];
  merlinSpeak(line, {
    more: () => merlinBriefing()
  });
}

// Idle chatter every ~3 minutes
setInterval(() => {
  if (document.getElementById("merlin-bubble").style.display === "none") {
    const line = MERLIN_LINES.idle[Math.floor(Math.random() * MERLIN_LINES.idle.length)];
    merlinSpeak(line);
  }
}, 3 * 60 * 1000);

// Patch loadDashboard to trigger greeting after data loads
const _origLoad = loadDashboard;
</script>

</body>
</html>
