<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bell 407 — Maintenance Dashboard</title>

  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Barlow+Condensed:wght@300;400;600;700;900&family=Barlow:wght@300;400;500&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#0a0c0f; --surface:#111418; --surface2:#181c22; --border:#1e2530;
      --green:#00e676; --amber:#ffab00; --red:#ff1744; --overdue:#ff6d00;
      --blue:#29b6f6; --text:#cdd6e0; --muted:#4a5568; --heading:#e8edf2;
      --mono:'Share Tech Mono', monospace;
      --sans:'Barlow Condensed', sans-serif;
      --body:'Barlow', sans-serif;
    }
    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      background:var(--bg);
      color:var(--text);
      font-family:var(--body);
      min-height:100vh;
      overflow-x:hidden;
    }
    body::before{
      content:'';
      position:fixed;
      inset:0;
      background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.03) 2px,rgba(0,0,0,0.03) 4px);
      pointer-events:none;
      z-index:1000;
    }

    header{
      background:var(--surface);
      border-bottom:1px solid var(--border);
      padding:18px 32px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      position:sticky;
      top:0;
      z-index:100;
    }
    .logo{
      font-family:var(--sans);
      font-weight:900;
      font-size:22px;
      letter-spacing:3px;
      color:var(--heading);
      text-transform:uppercase;
    }
    .logo span{ color:var(--blue); }
    .subtitle{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      letter-spacing:2px;
      text-transform:uppercase;
      margin-top:3px;
    }
    .header-meta{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      text-align:right;
      line-height:1.8;
    }
    .header-meta .date{ color:var(--blue); }

    main{
      padding:24px 32px;
      max-width:1600px;
      margin:0 auto;
    }

    .tabs{
      display:flex;
      gap:0;
      margin-bottom:18px;
      border-bottom:2px solid var(--border);
      flex-wrap:wrap;
    }
    .tab-btn{
      font-family:var(--sans);
      font-size:13px;
      font-weight:700;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:12px 24px;
      background:transparent;
      border:none;
      color:var(--muted);
      cursor:pointer;
      transition:all 0.2s;
      border-bottom:3px solid transparent;
    }
    .tab-btn:hover{ color:var(--text); background:rgba(255,255,255,0.02); }
    .tab-btn.active{ color:var(--blue); border-bottom-color:var(--blue); }
    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .section-label{
      font-family:var(--sans);
      font-size:11px;
      font-weight:600;
      letter-spacing:4px;
      text-transform:uppercase;
      color:var(--muted);
      margin:18px 0 12px;
      padding-bottom:6px;
      border-bottom:1px solid var(--border);
    }

    .summary-bar{
      display:flex;
      gap:16px;
      margin-bottom:18px;
      flex-wrap:wrap;
    }
    .summary-stat{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:4px;
      padding:12px 20px;
      min-width:150px;
    }
    .stat-value{
      font-family:var(--sans);
      font-size:32px;
      font-weight:900;
      line-height:1;
      margin-bottom:4px;
    }
    .stat-label{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:1.5px;
      text-transform:uppercase;
    }
    .divider-line{
      width:40px;
      height:2px;
      margin:8px 0;
      border-radius:1px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .search{
      flex:1;
      min-width:260px;
      display:flex;
      gap:8px;
      align-items:center;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:4px;
      padding:10px 12px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-family:var(--mono);
      font-size:12px;
    }
    .pill-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      font-family:var(--sans);
      font-size:12px;
      font-weight:700;
      letter-spacing:2px;
      text-transform:uppercase;
      padding:6px 12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted);
      border-radius:999px;
      cursor:pointer;
      transition:all .15s;
      user-select:none;
    }
    .pill:hover, .pill.active{
      background:var(--blue);
      border-color:var(--blue);
      color:#000;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill, minmax(380px, 1fr));
      gap:16px;
    }
    .card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:4px;
      overflow:hidden;
    }
    .card-h{
      padding:12px 16px;
      background:var(--surface2);
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:12px;
    }
    .card-title{
      font-family:var(--sans);
      font-weight:900;
      font-size:18px;
      letter-spacing:1px;
      color:var(--heading);
      text-transform:uppercase;
    }
    .card-sub{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      white-space:nowrap;
    }
    .card-b{ padding:10px 14px; }

    .row{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:10px 0;
      border-bottom:1px solid rgba(30,37,48,0.8);
    }
    .row:last-child{ border-bottom:none; }
    .ind{
      width:3px;
      height:32px;
      border-radius:2px;
      flex-shrink:0;
      margin-top:2px;
    }
    .ind-green{ background:var(--green); }
    .ind-amber{ background:var(--amber); }
    .ind-red{ background:var(--red); }
    .ind-overdue{ background:var(--overdue); animation:pulse 2s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{opacity:1;} 50%{opacity:.55;} }

    .row-main{ flex:1; min-width:0; }
    .row-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    .ata{
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      letter-spacing:1px;
      text-transform:uppercase;
      white-space:nowrap;
    }
    .desc{
      font-family:var(--body);
      font-size:12px;
      color:var(--text);
      font-weight:500;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .meta{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:2px;
      font-size:9px;
      font-family:var(--mono);
      letter-spacing:1px;
      border:1px solid transparent;
      white-space:nowrap;
    }
    .b-green{ background:rgba(0,230,118,0.10); color:var(--green); border-color:rgba(0,230,118,0.25); }
    .b-amber{ background:rgba(255,171,0,0.12); color:var(--amber); border-color:rgba(255,171,0,0.30); }
    .b-red{ background:rgba(255,23,68,0.12); color:var(--red); border-color:rgba(255,23,68,0.30); }
    .b-overdue{ background:rgba(255,109,0,0.14); color:var(--overdue); border-color:rgba(255,109,0,0.35); }

    .empty{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:4px;
      padding:18px;
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
    }

    footer{
      margin-top:28px;
      padding:16px 32px;
      border-top:1px solid var(--border);
      font-family:var(--mono);
      font-size:10px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      letter-spacing:1px;
      flex-wrap:wrap;
      gap:10px;
    }
    .hint{
      font-family:var(--mono);
      font-size:11px;
      color:var(--muted);
      margin:6px 0 12px;
    }
    .mono{ font-family:var(--mono); }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="logo">BELL <span>407</span> FLEET</div>
      <div class="subtitle">Maintenance Due List — Date-driven inspections</div>
    </div>
    <div class="header-meta">
      <div class="date" id="hdrReport">REPORT DATE: —</div>
      <div id="hdrGen">GENERATED: —</div>
    </div>
  </header>

  <main>
    <div class="tabs" id="tabs">
      <button class="tab-btn active" data-tab="inspections">Inspections</button>
      <button class="tab-btn" data-tab="ata">ATA View</button>
      <button class="tab-btn" data-tab="calendar" id="calendarTabBtn" style="display:none;">Calendar</button>
    </div>

    <div class="summary-bar" id="summaryBar">
      <div class="summary-stat">
        <div class="stat-value" style="color:var(--overdue)" id="sumOverdue">—</div>
        <div class="divider-line" style="background:var(--overdue)"></div>
        <div class="stat-label">Overdue</div>
      </div>
      <div class="summary-stat">
        <div class="stat-value" style="color:var(--red)" id="sumCritical">—</div>
        <div class="divider-line" style="background:var(--red)"></div>
        <div class="stat-label">Critical</div>
      </div>
      <div class="summary-stat">
        <div class="stat-value" style="color:var(--amber)" id="sumComing">—</div>
        <div class="divider-line" style="background:var(--amber)"></div>
        <div class="stat-label">Coming Due</div>
      </div>
      <div class="summary-stat">
        <div class="stat-value" style="color:var(--blue)" id="sumTotal">—</div>
        <div class="divider-line" style="background:var(--blue)"></div>
        <div class="stat-label">Tracked Items</div>
      </div>
    </div>

    <!-- INSPECTIONS TAB -->
    <div id="tab-inspections" class="tab-content active">
      <div class="toolbar">
        <div class="search">
          <span class="mono" style="color:var(--muted)">SEARCH</span>
          <input id="searchInspections" placeholder="Tail, ATA, description…" />
        </div>
        <div class="pill-row" id="severityPillsA">
          <div class="pill active" data-sev="all">All</div>
          <div class="pill" data-sev="overdue">Overdue</div>
          <div class="pill" data-sev="critical">Critical</div>
          <div class="pill" data-sev="coming">Coming Due</div>
          <div class="pill" data-sev="ok">OK</div>
        </div>
      </div>

      <div class="section-label">By Aircraft</div>
      <div class="grid" id="aircraftGrid"></div>
      <div id="aircraftEmpty" class="empty" style="display:none;">No matching inspection items.</div>
    </div>

    <!-- ATA TAB -->
    <div id="tab-ata" class="tab-content">
      <div class="toolbar">
        <div class="search">
          <span class="mono" style="color:var(--muted)">SEARCH</span>
          <input id="searchAta" placeholder="ATA, tail, description…" />
        </div>
        <div class="pill-row" id="severityPillsB">
          <div class="pill active" data-sev="all">All</div>
          <div class="pill" data-sev="overdue">Overdue</div>
          <div class="pill" data-sev="critical">Critical</div>
          <div class="pill" data-sev="coming">Coming Due</div>
          <div class="pill" data-sev="ok">OK</div>
        </div>
      </div>

      <div class="section-label">Grouped by ATA and Code</div>
      <div class="grid" id="ataGrid"></div>
      <div id="ataEmpty" class="empty" style="display:none;">No matching ATA items.</div>
    </div>

    <!-- CALENDAR TAB -->
    <div id="tab-calendar" class="tab-content">
      <div class="section-label">Projected Maintenance Calendar</div>
      <div class="hint">
        This tab is a placeholder. It will appear automatically once your JSON sets
        <span class="mono">show_calendar: true</span> (for example after you have enough history to project).
      </div>
      <div class="empty">
        Not enough flight-hours / utilization history to generate projections yet.
      </div>
    </div>
  </main>

  <footer>
    <span id="ftrSrc">SOURCE: Due List CSV → dashboard.json</span>
    <span>BELL 407 — AVIATION MAINTENANCE</span>
  </footer>

  <script>
    // ---- CONFIG ----
    // If your index.html is in dist/ and json is in dist/data/, use "data/dashboard.json".
    // If you serve from another base path, adjust here.
    const DASHBOARD_URL = "data/dashboard.json";

    // ---- STATE ----
    let DASH = null;
    let sevFilterA = "all";
    let sevFilterB = "all";

    // ---- HELPERS ----
    function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }

    function sevToOrder(sev){
      // for sorting: overdue first
      const m = { overdue:0, critical:1, coming:2, ok:3, unknown:4 };
      return m[sev] ?? 4;
    }

    function classify(item){
      // Expect item.severity set by generator, but fall back if needed.
      const sev = (item.severity || "").toLowerCase();
      if(["overdue","critical","coming","ok"].includes(sev)) return sev;

      const rd = item.remaining_days;
      const rh = item.remaining_hours;
      const status = norm(item.next_due_status);

      // overdue if status says so or remaining < 0
      if (status.includes("past due") || (Number.isFinite(rd) && rd < 0) || (Number.isFinite(rh) && rh < 0)) return "overdue";

      // critical: <= 7 days or <= 25 hours
      if ((Number.isFinite(rd) && rd <= 7) || (Number.isFinite(rh) && rh <= 25)) return "critical";

      // coming: <= 30 days or <= 100 hours
      if ((Number.isFinite(rd) && rd <= 30) || (Number.isFinite(rh) && rh <= 100)) return "coming";

      return "ok";
    }

    function indClass(sev){
      return {
        overdue: "ind-overdue",
        critical: "ind-red",
        coming: "ind-amber",
        ok: "ind-green",
      }[sev] || "ind-green";
    }

    function badgeClass(sev){
      return {
        overdue: "b-overdue",
        critical: "b-red",
        coming: "b-amber",
        ok: "b-green",
      }[sev] || "b-green";
    }

    function fmtDate(s){
      if(!s) return "—";
      // Accept ISO or mm/dd/yyyy
      const str = s.toString().trim();
      // If it looks like YYYY-MM-DD, keep first 10
      if (/^\d{4}-\d{2}-\d{2}/.test(str)) return str.slice(0,10);
      return str;
    }

    function fmtNum(n, digits=0){
      if(n === null || n === undefined || n === "") return "—";
      const x = Number(n);
      if(!Number.isFinite(x)) return "—";
      return x.toFixed(digits);
    }

    function matchesSev(item, sevWanted){
      if(sevWanted === "all") return true;
      const sev = classify(item);
      if(sevWanted === "ok") return sev === "ok";
      return sev === sevWanted;
    }

    function matchesSearch(item, q){
      if(!q) return true;
      const s = q.toLowerCase();
      const hay = [
        item.tail, item.ata, item.description, item.item_type, item.requirement_type,
        item.next_due_status, item.next_due_date, item.max_next_due_date
      ].map(x => (x ?? "").toString().toLowerCase()).join(" | ");
      return hay.includes(s);
    }

    // ---- RENDERERS ----
    function renderSummary(){
      const counts = DASH.summary || {};
      document.getElementById("sumOverdue").textContent = counts.overdue ?? 0;
      document.getElementById("sumCritical").textContent = counts.critical ?? 0;
      document.getElementById("sumComing").textContent  = counts.coming_due ?? 0;
      document.getElementById("sumTotal").textContent   = counts.total_tracked ?? (DASH.items?.length ?? 0);

      // Header meta
      document.getElementById("hdrReport").textContent = "REPORT DATE: " + (DASH.report_date || "—");
      document.getElementById("hdrGen").textContent = "GENERATED: " + (DASH.generated_at || "—");
    }

    function itemRowHTML(item){
      const sev = classify(item);

      const ata = item.ata || "—";
      const desc = item.description || item.name || "—";
      const tail = item.tail || "—";

      const dueDate = fmtDate(item.next_due_date);
      const remDays = Number.isFinite(Number(item.remaining_days)) ? Number(item.remaining_days) : null;
      const remHrs  = Number.isFinite(Number(item.remaining_hours)) ? Number(item.remaining_hours) : null;

      let dueLine = "";
      if(remDays !== null){
        dueLine = `${remDays < 0 ? "OVERDUE" : "REMAIN"}: ${fmtNum(remDays,0)} days • DUE: ${dueDate}`;
      }else if(remHrs !== null){
        dueLine = `${remHrs < 0 ? "OVERDUE" : "REMAIN"}: ${fmtNum(remHrs,1)} hrs • DUE: ${fmtNum(item.next_due_hours,1)} hrs`;
      }else{
        dueLine = `DUE: ${dueDate}`;
      }

      const status = (item.next_due_status || "").toString().trim();
      const badgeText = sev.toUpperCase();

      return `
        <div class="row" data-sev="${sev}">
          <div class="ind ${indClass(sev)}"></div>
          <div class="row-main">
            <div class="row-top">
              <div class="desc" title="${desc.replace(/"/g,'&quot;')}">${desc}</div>
              <div class="ata">${ata}</div>
            </div>
            <div class="meta">
              <span class="badge ${badgeClass(sev)}">${badgeText}</span>
              <span class="mono">${tail}</span>
              <span class="mono">${dueLine}</span>
              ${status ? `<span class="mono">STATUS: ${status}</span>` : ``}
            </div>
          </div>
        </div>
      `;
    }

    function renderByAircraft(){
      const grid = document.getElementById("aircraftGrid");
      const empty = document.getElementById("aircraftEmpty");
      grid.innerHTML = "";

      const q = norm(document.getElementById("searchInspections").value);

      const byA = DASH.by_aircraft || {};
      const tails = Object.keys(byA).sort();

      let cards = 0;

      for(const tail of tails){
        const itemsRaw = byA[tail] || [];
        const items = itemsRaw
          .filter(it => matchesSev(it, sevFilterA))
          .filter(it => matchesSearch(it, q))
          .sort((a,b) => sevToOrder(classify(a)) - sevToOrder(classify(b)));

        if(items.length === 0) continue;

        cards++;
        const rows = items.map(itemRowHTML).join("");
        const sub = `${items.length} item${items.length===1?"":"s"}`;

        grid.insertAdjacentHTML("beforeend", `
          <div class="card">
            <div class="card-h">
              <div class="card-title">${tail}</div>
              <div class="card-sub">${sub}</div>
            </div>
            <div class="card-b">${rows}</div>
          </div>
        `);
      }

      empty.style.display = cards ? "none" : "block";
    }

    function renderByATA(){
      const grid = document.getElementById("ataGrid");
      const empty = document.getElementById("ataEmpty");
      grid.innerHTML = "";

      const q = norm(document.getElementById("searchAta").value);

      const byATA = DASH.by_ata || {};
      const ataKeys = Object.keys(byATA).sort((a,b) => a.localeCompare(b));

      let cards = 0;

      for(const ata of ataKeys){
        const itemsRaw = byATA[ata] || [];
        const items = itemsRaw
          .filter(it => matchesSev(it, sevFilterB))
          .filter(it => matchesSearch(it, q))
          .sort((a,b) => sevToOrder(classify(a)) - sevToOrder(classify(b)));

        if(items.length === 0) continue;

        cards++;
        const rows = items.map(itemRowHTML).join("");
        const sub = `${items.length} item${items.length===1?"":"s"}`;

        grid.insertAdjacentHTML("beforeend", `
          <div class="card">
            <div class="card-h">
              <div class="card-title" title="${ata}">${ata}</div>
              <div class="card-sub">${sub}</div>
            </div>
            <div class="card-b">${rows}</div>
          </div>
        `);
      }

      empty.style.display = cards ? "none" : "block";
    }

    function setActiveTab(tabName){
      document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));

      const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
      const tab = document.getElementById(`tab-${tabName}`);
      if(btn) btn.classList.add("active");
      if(tab) tab.classList.add("active");
    }

    function wirePills(containerId, setterFn){
      const c = document.getElementById(containerId);
      c.querySelectorAll(".pill").forEach(p => {
        p.addEventListener("click", () => {
          c.querySelectorAll(".pill").forEach(x => x.classList.remove("active"));
          p.classList.add("active");
          setterFn(p.getAttribute("data-sev"));
        });
      });
    }

    async function loadDashboard(){
      // cache-bust so GitHub Pages updates show immediately
      const url = `${DASHBOARD_URL}?v=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      if(!res.ok) throw new Error(`Failed to load ${url}: HTTP ${res.status}`);
      return await res.json();
    }

    // ---- INIT ----
    (async function init(){
      try{
        DASH = await loadDashboard();

        renderSummary();

        // Calendar tab: show only if generator says so
        const showCal = !!DASH.show_calendar;
        const calBtn = document.getElementById("calendarTabBtn");
        if(showCal) calBtn.style.display = "";
        else calBtn.style.display = "none";

        // Tab click wiring
        document.getElementById("tabs").addEventListener("click", (e) => {
          const btn = e.target.closest(".tab-btn");
          if(!btn) return;
          setActiveTab(btn.getAttribute("data-tab"));
        });

        // Filters + searches
        wirePills("severityPillsA", (sev) => { sevFilterA = sev; renderByAircraft(); });
        wirePills("severityPillsB", (sev) => { sevFilterB = sev; renderByATA(); });

        document.getElementById("searchInspections").addEventListener("input", () => renderByAircraft());
        document.getElementById("searchAta").addEventListener("input", () => renderByATA());

        // Initial render
        renderByAircraft();
        renderByATA();

      }catch(err){
        console.error(err);
        document.getElementById("aircraftGrid").innerHTML = "";
        document.getElementById("ataGrid").innerHTML = "";
        document.getElementById("aircraftEmpty").style.display = "block";
        document.getElementById("ataEmpty").style.display = "block";
        document.getElementById("aircraftEmpty").textContent = "Error loading dashboard.json. Open DevTools console for details.";
        document.getElementById("ataEmpty").textContent = "Error loading dashboard.json. Open DevTools console for details.";
      }
    })();
  </script>
</body>
</html>
